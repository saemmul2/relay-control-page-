<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>릴레이 제어 및 상태 확인</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: 50px;
        }
        .status-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            font-weight: bold;
            color: #495057;
        }
        .status-value {
            font-weight: bold;
        }
        .status-connected {
            color: #28a745;
        }
        .status-disconnected {
            color: #dc3545;
        }
        .status-on {
            color: #dc3545;
        }
        .status-off {
            color: #28a745;
        }
        .control-section {
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        .control-buttons .btn {
            margin: 5px;
            width: calc(33.333% - 10px);
        }
        .setting-time-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .setting-time-group .form-control {
            width: 80px;
            text-align: center;
        }
        .setting-time-group span {
            margin: 0 5px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .time-info {
            font-size: 1rem;
            color: #6c757d;
            margin-top: 10px;
        }
        .time-info .note {
            font-size: 0.8rem;
            color: #999;
        }
        @media (max-width: 576px) {
            .control-buttons .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">릴레이 제어 및 상태 확인</h2>

    <div class="status-box">
        <div class="status-item">
            <span class="status-label">현재 시간 (KST):</span>
            <span id="current-time" class="status-value">정보 없음</span>
        </div>
        <div class="status-item">
            <span class="status-label">일몰 시간 (KST):</span>
            <span id="sunset-time" class="status-value">정보 없음</span>
        </div>
        <div class="status-item">
            <span class="status-label">릴레이 끄는 시간:</span>
            <span id="auto-off-time" class="status-value">정보 없음</span>
        </div>
        <div class="time-info">
            <span class="note">(*이 시간 정보는 ESP8266에서 MQTT로 발행해야 표시됩니다.)</span>
        </div>
    </div>

    <div class="status-box">
        <div class="status-item">
            <span class="status-label">MQTT 연결 상태:</span>
            <span id="mqtt-status" class="status-value status-disconnected">연결 안됨</span>
        </div>
        <div class="status-item">
            <span class="status-label">릴레이 상태:</span>
            <span id="relay-status" class="status-value status-off">꺼짐</span>
        </div>
        <div class="status-item">
            <span class="status-label">제어 모드:</span>
            <span id="control-mode" class="status-value">수동</span>
        </div>
    </div>

    <div class="control-section">
        <h4 class="text-center">릴레이 끄는 시간 설정</h4>
        <div class="setting-time-group d-flex justify-content-center">
            <input type="number" id="set-hour" class="form-control" value="21" min="0" max="23">
            <span>:</span>
            <input type="number" id="set-minute" class="form-control" value="0" min="0" max="59">
            <button class="btn btn-warning ms-2" onclick="send_set_time()">설정</button>
        </div>
        <h4 class="text-center">수동 제어 및 모드 변경</h4>
        <div class="control-buttons text-center">
            <button class="btn btn-success" onclick="send_on()">릴레이 켜기</button>
            <button class="btn btn-danger" onclick="send_off()">릴레이 끄기</button>
            <button class="btn btn-primary" onclick="send_auto()">자동 모드</button>
        </div>
        <div class="control-buttons text-center mt-3">
            <button class="btn btn-danger" onclick="send_reset_eeprom()">EEPROM 초기화</button>
        </div>
        
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
<script>
    const mqtt_server = "2ad3a77d41d54305b9155c4fce321dd3.s1.eu.hivemq.cloud";
    const mqtt_port = 8884;
    const mqtt_user = "edench";
    const mqtt_password = "Eden1440";

    const topic_status = "esp32/status";
    const topic_time = "esp32/time_data";
    const topic_control = "esp32/control";

    const client = mqtt.connect(`wss://${mqtt_server}:${mqtt_port}/mqtt`, {
        username: mqtt_user,
        password: mqtt_password
    });

    client.on('connect', function () {
        document.getElementById('mqtt-status').textContent = '연결됨';
        document.getElementById('mqtt-status').className = 'status-value status-connected';
        console.log("MQTT Connected");
        client.subscribe(topic_status);
        client.subscribe(topic_time);
        publish_message(topic_control, "REQUEST_STATUS"); // 연결 시 상태 요청
    });

    client.on('error', function (error) {
        document.getElementById('mqtt-status').textContent = '연결 안됨';
        document.getElementById('mqtt-status').className = 'status-value status-disconnected';
        console.error("MQTT Error: ", error);
    });

    client.on('message', function (topic, message) {
        try {
            const msgStr = message.toString();
            console.log(`Message received on topic ${topic}: ${msgStr}`);

            if (topic === topic_status) {
                const data = JSON.parse(msgStr);
                document.getElementById('relay-status').textContent = (data.status === 'ON') ? '켜짐' : '꺼짐';
                document.getElementById('relay-status').className = 'status-value ' + ((data.status === 'ON') ? 'status-on' : 'status-off');
                document.getElementById('control-mode').textContent = (data.mode === 'auto') ? '자동' : '수동';

            } else if (topic === topic_time) {
                const data = JSON.parse(msgStr);
                document.getElementById('current-time').textContent = data.current_time;
                document.getElementById('sunset-time').textContent = data.sunset_time;
                document.getElementById('auto-off-time').textContent = data.auto_off_time;
            }
        } catch (e) {
            console.error("Error parsing message: ", e);
        }
    });

    function publish_message(topic, message) {
        if (client.connected) {
            client.publish(topic, message);
        } else {
            console.error("Client not connected, cannot publish message.");
        }
    }

    function send_on() {
        publish_message(topic_control, "ON");
    }

    function send_off() {
        publish_message(topic_control, "OFF");
    }

    function send_auto() {
        publish_message(topic_control, "auto");
    }

    function send_set_time() {
        const hour = document.getElementById('set-hour').value;
        const minute = document.getElementById('set-minute').value;
        publish_message(topic_control, `SET_TIME:${hour}:${minute}`);
    }

    function send_reset_eeprom() {
        const confirmReset = confirm("EEPROM 초기화 시, 릴레이 끄는 시간이 21시로 초기화됩니다. 계속하시겠습니까?");
        if (confirmReset) {
            publish_message(topic_control, "RESET_EEPROM");
        }
    }
</script>

</body>
</html>
